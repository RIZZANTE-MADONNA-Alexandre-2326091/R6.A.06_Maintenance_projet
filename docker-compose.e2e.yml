services:
  # BACKEND
  backend_e2e:
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    volumes:
      - ./backend:/app
    environment:
      - DATABASE_URL=postgresql://chtiouimaxxing_balk_ans:fF6bdTQfwR@postgresql-chtiouimaxxing.alwaysdata.net:5432/chtiouimaxxing_pg?serverVersion=16&charset=utf8
    command: sh -c "composer install -q && php -S 0.0.0.0:8000 -t public"
    ports:
      - "8000:8000"

  # FRONTEND
  frontend_e2e:
    build:
      context: ./frontend
      dockerfile: Dockerfile.test
    environment:
      - VITE_API_URL=http://backend_e2e:8000
    depends_on:
      - backend_e2e
    ports:
      - "3000:3000"

  # CYPRESS (Testeur)
  cypress:
    image: cypress/included:13.6.6
    depends_on:
      - frontend_e2e
    environment:
      - CYPRESS_baseUrl=http://frontend_e2e:3000
    working_dir: /e2e
    volumes:
      - ./frontend:/e2e
    ipc: host
    command: cypress run
